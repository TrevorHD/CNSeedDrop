---
title: "Final Project Report"
author: "Trevor Drees and Emily Howerton"
date: "December 15, 2019"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: no
    fig_height: 4
    fig_width: 5
editor_options: 
  chunk_output_type: console
header-includes:
- \usepackage{float}
- \usepackage[width=0.8\textwidth]{caption}
urlcolor: blue
---

```{r setup, include = FALSE}

# Load packages
library(knitr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(agricolae)
library(MASS)
library(maditr)
library(corrplot)
library(leaps)
library(car)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.pos = 'H')
options(knitr.kable.NA = "")

#Initialise data
data <- read.csv("https://raw.githubusercontent.com/TrevorHD/CNSeedDrop/master/SeedDropData.csv")

# Treating pappus as cone-shaped, calculate vertex angle, base area, volume, and height
# Also calculate terminal velocity given drop time and fixed drop height
data %>% mutate(SeedAngle = acos(1 - ((SeedWidth^2)/(2*(SeedLength^2)))),
                SeedArea = pi*((SeedWidth/2)^2),
                SeedHeight = sqrt(SeedLength^2 - (SeedWidth/2)^2),
                SeedVol = (pi/3)*((SeedWidth/2)^2)*SeedHeight,
                TV = 1.25/DT.Avg) -> data

# Create new data set that excludes instances where pappus length, width, or DT are NA
data.new <- data[complete.cases(data[ , 23:25]), ]

# Need unique plot indicators by block - plot 1 and plot 2 are not similar in any way across blocks
data.new$PlotUnique = as.factor(paste(data.new$Block, "_", data.new$Plot))
# use PlantID for position

# Create a mowing y/n flag
data.new$MowYN = ifelse(data.new$Mow == "CTL", 0, 1)
```

# Abstract
The invasive thistle *Carduus nutans* has been a management concern for landowners and governments alike, with dispersal in this plant playing an important role in its spread. Given that the terminal velocity of *C. nutans* seeds strongly influences dispersal distance, we seek to beter understand how both pappus shape and treatment of the parent plant affect seed terminal velocity. Our analyses show that the width of the seed pappus was the most important factor in determining seed terminal velocity and that the two were negatively correlated, with higher pappus width generally giving rise to a lower terminal velocity. Warming and mowing treatments on parent plants had significant effects on the pappus width, with warmed and mowed plants having a much smaller pappus width. Regarding the effects of the treatments on seed terminal velocity, early mowing increased terminal velocity, while warming decreased terminal velocity; no significant effect was observed for late mowed plants compared to control plants. Given that mowing was shown to increase pappus width and that increased pappus width was shown to reduce terminal velocity, it is surprising that plants experiencing the early mowing treatment had higher seed terminal velocity. Such a contridiction warrants further investigation of additional factors, such as mass, that may affect seed terminal velocity.

# Introduction and Data

As the world has become significantly more interconnected, the increased movement of people across the world has also facilitated an increase in the spread of species outside of their native ranges. When species that are introduced outside of their native range become invasive, they can have a detrimental impact on local biodiversity, quantity and quality of valuable ecosystem services, and other aspects of the local ecosystem. Because of this, the study of invasive species has been a large part of the ecology literature in recent decades, ranging from theoretical models of how they spread to investigating possible management practices that keep them at bay.

One particular invasive species that has greatly expanded its range due to human activity is *Carduus nutans*, also known as "musk thistle" or "nodding thistle". This thistle is native to Europe and Central Asia, but has expanded its range into North America, Australia, and New Zealand, among other parts of the world$^1$. Within the U.S., this thistle has been reported in all U.S. states except for Alaska, Florida, Hawaii, Maine, and Vermont$^2$; the thistle may even be present in these states, but has not yet been reported. It is also been reported all Canadian provinces except Nunavut, Northwest Territories, and Yukon Territories$^2$.
  
*C. nutans* is considered to be a noxious weed in many U.S. states for several reasons. Because it can occur in very large numbers and grow to be quite large, this thistle may form dense and often impenetrable stands. The plant is also covered in numerous large spines, making it painful when touched as well as unpalatable to grazing animals. The adverse impacts of this weed on grazing can also lead to substantial economic losses.

Another reason why there is concern over *C. nutans* is because it has a high potential to spread locally when introduced. This thistle is wind dispersed and seeds have a large pappus, or a feathery and lightweight modified calyx, on the seeds that allows them to be transported great distances. Models have been proposed to model such wind-driven seed dispersal$^3$, and such models have been applied to *C. nutans*$^4$, showing significant potential for long-range dispersal events. While there are abiotic and biotic factors that affect how far a seed like those in *C. nutans* can be dispersed, a noteworthy predictor of dispersal distance is seed terminal velocity. For seeds, a higher terminal velocity generally means a decreased dispersal distance; this is because a higher terminal velocity means the seed falls faster and thus spends less time in the air, which means less of an opportunity for wind to carry it further from its source.

However, it is not entirely clear what affects terminal velocity in *C. nutans* seeds, though the most obvious candidates would be physical properties of the seed such as shape and mass. In general, seeds with pappi that have a larger area perpendicular to the direction of motion will have higher drag and a lower terminal velocity. Seeds with a higher mass will have a higher downward force (*mg*) from gravity and thus a higher air resistance force that must equal it to achieve terminal velocity, which leads to a higher terminal velocity since said resistance force is proportional to that velocity. However, the physical properties of the seed may be affected by the morphology and physiology of the parent plant; abiotic and biotic factors can affect the parent plant in such a way that may ultimately influence the terminal velocity of its seeds.

Given that there may be a link between abiotic influences on *C. nutans* and the terminal velocity of its seeds, we wish to investigate whether certain treatments applied to the plant before it flowers have any effect on seed dispersal capabilities. Any treatment effects that can reduce the dispersal capability of these thistles may then be used to inform management decisions. By using mowing treatments as well as warming treatments (and combinations of the two), we will examine the effects of said treatments on seed terminal velocity and thus on dispersal capability.

The data used to assess the effects of mowing and warming on seed terminal velocity were collected during a field experiment that involved applying these treatments to parent plants and collecting their flower heads aftey they had set seed. The experimental setup involves ten blocks, with each block containing two plots: one plot with a warming treatment and one without. Within each plot there are three positions: one with an early mowing treatment, one with a late mowing treatment, and one with no mowing at all. Overall, this yields six unique combinations of warming and mowing, with 10 replicates for each combination. Ten seeds were planted at each position, and one flower head was harvested from all individuals that survived to harvest date. Seeds were collected from individual flower heads and their terminal velocities were determined by recording the amount of time it took them to fall through a 1.25-m drop chamber. For each seed, these drop tests were repeated until two consecutive drop times were recorded within 0.1 seconds of each other.

Using the data from the experiment described above, we seek answers to three research questions of interest:

\begin{enumerate}
\item Is seed terminal velocity predicted by the shape of the seed pappus?
\item To what extent do warming and mowing treatments change seed terminal velocity?
\item Can changes in seed terminal velocity by treatment be explained by changes in pappus shape?
\end{enumerate}

# Research Question 1 

``` {r}
# Remove any rows where the quantities defined above are NaN
data.new <- data.new[-which(is.nan(data.new[, 36])), ]
```

First, we begin by investigating how pappus dimensions affect seed terminal velocity, with a total of six different measurements on the pappus used as predictors. The first two measurements are `SeedWidth` and `SeedLength`, which are respectively the basal width and slant height of a cone-shaped pappus. These measurements are empirically derived and are both measured in millimetres. Four additional measurements are calculated using `SeedWidth` and `SeedLength` and are as follows:

\begin{enumerate}
\item SeedAngle, the vertex angle of the conical pappus (radians)
\item SeedArea, the basal area of the conical pappus (mm$^2$)
\item SeedHeight, the height of the conical pappus (mm)
\item SeedVol, the volume of the conical pappus (mm$^3$)
\end{enumerate}

Before any models are fit to the data, we first examine correlations between the various pappus measurements given above. A `pairs` plot of terminal velocity and the various physical properties can be seen in Figure \ref{fig:TVPairsPlot}. Linear associations between the variables can also be seen in Figure \ref{fig:TVCorrPlot}, with both the strength and directions of the correlations shown.

``` {r TVPairsPlot, fig.height = 6, fig.width = 10, fig.cap = "\\label{fig:TVPairsPlot} Pairs plot of relationships between variables considered in this analysis."}
pairs(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")])
```

``` {r TVCorrPlot, fig.height = 6, fig.width = 10, fig.cap = "\\label{fig:TVCorrPlot} Linear correlations between variables considered in this analysis."}
corrplot(cor(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")]),
         method = "number", type = "lower", tl.pos = "n", cl.pos = "n", tl.col = "black")
corrplot(cor(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")]),
         method = "square", type = "upper", tl.pos = "lt", add = TRUE, tl.col = "black")
```

Between the `pairs` plot and the correlation matrix/heatmap, it is clear that multicollinearity will be an issue since several of the variables are highly correlated with each other (e.g. `SeedWidth` and `SeedAngle`, `SeedWidth` and `SeedArea`, etc.). Given that several predictors are calculated from `SeedWidth` and `SeedHeight`, this is not surprising.

Our first model uses the terminal velocity `TV` as a response and all six of the pappus measurements as predictors. The resulting coefficients and their significance are listed in Table \ref{tab:FullModelTable}. It is clear that this model is a poor fit for two main reasons. First, many of the terms are not significant to $\alpha = 0.05$ and add no significant additional predictive power to the model. Second, the VIF (variance inflation factor) for all of the coefficients is quite high, as was predicted.

``` {r FullModelTable}
mod.full <- lm(TV ~ SeedWidth + SeedLength + SeedArea + SeedAngle + SeedHeight + 
                    SeedVol, data = data.new)
mod.full.out <- as.data.frame(cbind(round(summary(mod.full)$coefficients, digits = 4),
                                    c(NA, round(vif(mod.full), digits = 4)),
                                    c("***", "**", ".", "", "", "", "*")))
dimnames(mod.full.out)[[2]] <- c("Estimate", "Std. Error", "t value", "Pr(>|t|)",
                                 "VIF", "Significance")
kable(mod.full.out, align = "r", caption = "\\label{tab:FullModelTable} Estimates of the regression coefficients                                             and associated measurements for the full model. Terms with at least                                             one asterisk are significant at the 0.05 level.")
```

Given that some of these variables must be removed to improve the fit of the model, we now perform variable selection on the full model to reduce clutter. The first method of selection is backwards selection starting from the full model above, which involves removing subsequent variables based on their *p*-value; the variable with the highest *p*-value is removed, the resulting model re-examined, and the process repeated until all predictors were significant at $\alpha = 0.05$. The second method of selection involves backwards selection from the full model using AIC (Akaike's information), where terms are removed until the AIC of the model is minimised. The third mehtod of selection starts from the full model and uses the `step` selection function in both directions, while the fourth method starts from the null model and added terms; again, in both cases, the selection continues until the AIC of the model is minimised. The results from the model selection can be found in Table \ref{tab:ModelComparisonTable}, along with the VIF for each term as well as both the AIC and $R^2$ for each resulting model. All coefficients are significant to $\alpha < 0.001$.

``` {r, include = FALSE}
# Backward elimination, no AIC or BIC; remove "worst" predictor
mod.1 <- update(mod.full, . ~ . - SeedAngle)
summary(mod.1)
mod.1 <- update(mod.1, . ~ . - SeedArea)
summary(mod.1)

# Backward elimination with AIC produces the exact same result
step(mod.full, direction = "backward", data = data.new)

# Step in both directions with AIC produces the exact same result
step(mod.full, direction = "both", data = data.new)

# Forward selection with AIC
mod.null <- lm(TV ~ 1, data = data.new)
step(mod.null, direction = "forward", scope = list(lower = mod.null, upper = mod.full), data = data.new)
mod.2 <- lm(TV ~ SeedWidth + SeedArea, data = data.new)
summary(mod.2)
```

``` {r ModelComparisonTable}
# mod.1.out <- cbind(c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
#                    c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
#                    c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
#                    c(summary(mod.2)$coefficients[1:2, 1], NA, summary(mod.1)$coefficients[4, 1], rep(NA, 3)),
#                    c(NA, vif(mod.1)[1:2], rep(NA, 2), vif(mod.1)[3:4]),
#                    c(NA, vif(mod.2)[1], NA, vif(mod.2)[2], rep(NA, 3)))
# mod.1.out <- rbind(mod.1.out, c(rep(-1293.6, 3), -1288.4, rep(NA, 2)),
#                               c(rep(summary(mod.1)$adj.r.squared, 3), summary(mod.2)$adj.r.squared, rep(NA, 2)))
# mod.1.out <- round(mod.1.out, digits = 4)
# dimnames(mod.1.out)[[1]] <- c(dimnames(mod.full.out)[[1]], "AIC", "$R^2$")
# dimnames(mod.1.out)[[2]] <- c("Method 1", "Method 2", "Method 3", "Method 4", "Model 1 VIF", "Model 2 VIF")

coeff.1 = round(summary(mod.1)$coefficients,4)
confint.1 = round(confint(mod.1),4)
coeff.2 = round(summary(mod.2)$coefficients,4) 
confint.2 = round(confint(mod.2),4)
vif.1 = round(vif(mod.1),4)
vif.2 = round(vif(mod.2),4)

mod.1.out <- cbind(c(paste(coeff.1[1:3, 1], " (",confint.1[1:3,1]," ,", confint.1[1:3,2],")", sep = ""), 
                     rep(NA, 2), paste(coeff.1[4:5, 1], " (",confint.1[4:5,1]," ,", confint.1[4:5,2],")", sep = "")),
                   c(paste(coeff.2[1:2, 1], " (",confint.2[1:2,1]," ,", confint.2[1:2,2],")", sep = ""), 
                     NA, paste(coeff.2[3, 1], " (",confint.2[3,1]," ,", confint.2[3,2],")", sep = ""), rep(NA, 3)),
                   c(NA, vif.1[1:2], rep(NA, 2), vif.1[3:4]),
                   c(NA, vif.2[1], NA, vif.2[2], rep(NA, 3)))
mod.1.out <- rbind(mod.1.out, c(-1293.6, -1288.4, rep(NA, 2)),
                              c(round(summary(mod.1)$adj.r.squared, 4), round(summary(mod.2)$adj.r.squared,4), rep(NA, 2)))
#mod.1.out <- round(mod.1.out, digits = 4)
dimnames(mod.1.out)[[1]] <- c(dimnames(mod.full.out)[[1]], "AIC", "$R^2$")
dimnames(mod.1.out)[[2]] <- c("Methods 1-3", "Method 4", "Model 1 VIF", "Model 2 VIF")
kable(mod.1.out, align = "r", caption = "\\label{tab:ModelComparisonTable} Estimates of the regression                                                  coefficients for Model 1 (resulting from methods 1-3) and Model 4                                               (resulting from method 4). 95% confidence intervals given in parentheses.")

```

As we can see in the table, the first three selection methods produce the exact same result (which will henceforth be referred to as Model 1), while the fourth method produces a result with only two terms (henceforth Model 2). While Model 1 has a higher $R^2$ and lower AIC than Model 2, it suffers greatly from high VIF. Because the VIF on Model 2 is much lower that that of Model 1 and the difference in $R^2$ is very small, we will proceed with Model 2, effectively trading a small increase in the amount of unexplained variance for a large decrease in multicollinearity.

``` {r, include = FALSE}
mod.3 <- lm(TV ~ SeedWidth, data = data.new)
anova(mod.2, mod.3)
```

However, even in Model 2, we still see a rather high VIF for the `SeedWidth` and `SeedArea` terms. While the `SeedArea` term may be inflating coefficient estimates when added to `SeedWidth`, a partial *F*-test confirms that its addition is statistically significant (*F* = 32.43, *p* < 0.001). Since `SeedArea` is proportional to the square of `SeedWidth`, we can simply express it as as a quadratic term in a polynomial regression instead of using a separate `SeedArea` variable for it. Let Model 3 be the polynomial regression that replaces Model 2, and let model 4 be a reduced model such that:

\begin{itemize}
\item Model 3: $Terminal Velocity = \beta_0 + \beta_1 SeedWidth$
\item Model 4: $Terminal Velocity = \beta_0 + \beta_1 SeedWidth + \beta_2 SeedWidth^2$
\end{itemize}

``` {r, include = FALSE}
mod.4 <- lm(TV ~ SeedWidth + I(SeedWidth^2), data = data.new)
summary(mod.3)
summary(mod.4)
```

Comparing Model 4 to Model 3 (where VIF is not an issue), we see that the simpler Model 3 is not as good of a fit, with an $R^2$ of 0.3274 compared to 0.3804 for Model 4. This is also clear when plotting the models against the data, as can be seen in Figure \ref{fig:TVComparisonPlot}; there is clearly a curved pattern in the data points and Model 4 does a significantly better job of capturing it than Model 3.

We can also compare the distribution of residuals between the two models to check their validity. As can be seen in Figure \ref{fig:R1ComparisonPlot}, the residuals are approximately normally-distributed for both models, with a bit of deviation from normality at the tails of the distribution. However, there are clearly differences regarding patterns of distribution in the residuals, as shown in Figure \ref{fig:R2ComparisonPlot} and Figure \ref{fig:R3ComparisonPlot}. For Model 3, there appears to be some curvature in the distribution of residuals, suggesting that an invalid model has been fit to the data. However, in Model 4, the curved pattern in the residuals disappears, suggesting that this model is more valid.

``` {r TVComparisonPlot, fig.height = 6, fig.width = 10, fig.cap = "\\label{fig:TVComparisonPlot} Plot of seed terminal velocity as a function  of pappus width. The two models are also plotted: the quadratic model (orange) and the linear model (blue)."}
testdata <- data.frame(SeedWidth = seq(min(data.new$SeedWidth), max(data.new$SeedWidth), length.out = 300))
testdata = cbind(testdata, predict(mod.4, newdata = testdata, interval = "confidence"))
testdata = rbind(testdata, cbind(SeedWidth = seq(min(data.new$SeedWidth), max(data.new$SeedWidth), length.out = 300), predict(mod.3, newdata = testdata, interval = "confidence")))
testdata$Model = factor(c(rep("Quadratic Model", times = 300), rep("Linear Model", times = 300)))
ggplot(data = testdata, aes(x = SeedWidth))+
  geom_point(data = data.new, aes(x = SeedWidth, y = TV), shape = 1, size = 1.8)+
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = Model), alpha = 0.25)+
  geom_line(aes(y = fit, color = Model), size = 1.2)+
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none") +
  labs(x = "Seed Pappus Width (mm)", y = "Terminal Velocity (m/s)")+
  scale_color_manual(values = c("deepskyblue","chocolate1"))+
  scale_fill_manual(values = c("deepskyblue","chocolate1"))
remove(testdata)
```

``` {r R1ComparisonPlot, fig.height = 14, fig.width = 12, fig.cap = "\\label{fig:R1ComparisonPlot} Q-Q Plots comparing normality of the residuals in the linear model (top) and quadratic model (bottom)."}
par(mfrow = c(2, 1))
plot(mod.3, which = 2, cex.lab = 1.6, cex.axis = 1.4, main = NA)
plot(mod.4, which = 2, cex.lab = 1.6, cex.axis = 1.4, main = NA)
```

``` {r R2ComparisonPlot, fig.height = 14, fig.width = 12, fig.cap = "\\label{fig:R2ComparisonPlot} Comparison of residual distributions as a function of fitted values in the linear model (top) and quadratic model (bottom)."}
par(mfrow = c(2, 1))
plot(mod.3, which = 1, cex.lab = 1.6, cex.axis = 1.4, main = NA)
plot(mod.4, which = 1, cex.lab = 1.6, cex.axis = 1.4, main = NA)
```

``` {r R3ComparisonPlot, fig.height = 14, fig.width = 12, fig.cap = "\\label{fig:R3ComparisonPlot} Comparison of standardised residual distributions as a function of observed values in the linear model (top) and quadratic model (bottom)."}
par(mfrow = c(2, 1))
plot(rstandard(mod.3) ~ SeedWidth, data = data.new, ylab = "Standardised Residuals",
     cex.lab = 1.6, cex.axis = 1.4)
abline(h = 0, col = "red")
abline(h = c(-2, 2), col = "red", lty = 3)
plot(rstandard(mod.4) ~ SeedWidth, data = data.new, ylab = "Standardised Residuals",
     cex.lab = 1.6, cex.axis = 1.4)
abline(h = 0, col = "red")
abline(h = c(-2, 2), col = "red", lty = 3)
```

The model resulting from this analysis suggests two things. First, pappus width is the most important aspect of pappus shape in determining seed terminal velocity; while other aspects of the pappus shape may be used to predict seed terminal velocity, they are not particularly helpful when pappus width is already considered. Second, there is a significant negative correlation between pappus width and seed terminal velocity.

# Research Question 2

In addition to predicting seed terminal velocity based on the physical dimensions of the seed pappus, we are also interested in quantifying the extent to which two environmental effects (warming and mowing), affect seed terminal velocity.  Using the variation in termnal velocity across all six treatments shown in Figure \ref{fig:TVbarplot}, we can generate a preliminary hypothesis that warming increases terminal velocity while mowing decreases it. The following analysis determines whether such differences are statistically significant.

```{r TVbarplot, fig.cap = "\\label{fig:TVbarplot}Terminal velocity for plants grown under warming and mowing treatments. Height of bar shows group mean, and error bars show one standard error. Actual data shown with black dots. Less data exist for late mowed plants, as many of them died."}
barplot.dat <- aggregate(data.new$TV, by = list(Mowing = data.new$Mow, Warming = data.new$Warming), 
                         FUN = function(x) c(mean(x), sd = sd(x), n = length(x)))
barplot.dat <- do.call(data.frame, barplot.dat)
barplot.dat$SE <- barplot.dat$x.sd/sqrt(barplot.dat$x.n)
colnames(barplot.dat) <- c("Mowing", "Warming", "Mean", "SD", "n", "SE")

ggplot(data = barplot.dat, aes(Mowing, Mean, fill = Warming)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_point(data = data.new, aes(x = Mow, group = Warming, y = TV), 
             position = position_jitterdodge(dodge.width = 0.9), alpha = 0.5, shape = 16) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2, position = position_dodge(0.9)) +
  labs(y = "Terminal Velocity (m/s)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Because we are fitting a continutous response variable to categorical predictor variables, we can use an ANOVA model to characterize changes in terminal velocity by treatment. In order to compensate for the skewed right distribution of the terminal velocity data and significant deviations from error normality (Figure \ref{fig:TVHistAndErrors}), we log-transform terminal velocity for this analysis. We use two methods to identify the most appropriate model fit for the log-transformed terminal velocity data, starting by fitting the following four models:

```{r TVHistAndErrors, fig.height = 3, fig.width = 6, fig.cap = "\\label{fig:TVHistAndErrors} Histogram of terminal velocity (A) and normal Q-Q plot of linear model with both warming and mowing predictors (B)."}

# show TV histogram
p1 <- ggplot(data = data.new) +
  geom_histogram(aes(TV), fill = "white", color = "black", bins = 10) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(x = "Terminal Velocity (m/s)", y = "Count", tag = "A")
# show residuals 
mod.TV <- lm(TV ~ Warming + Mow, data = data.new)
resid <- as.data.frame(mod.TV$residuals)
colnames(resid) <- c("Residuals")
p2 <- ggplot(resid, aes(sample = Residuals)) +
  stat_qq() + 
  stat_qq_line() +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(x = "Theoretical", y = "Sample", tag = "B")
grid.arrange(p1, p2, nrow = 1)

```

\begin{itemize}
\item Mowing Only: $Terminal Velcotiy = \beta_0 + \beta_1 Mow$
\item Warming Only: $Terminal Velocity = \beta_0  + \beta_1 Warm$
\item Warming and Mowing: $Terminal Velocity = \beta_0 + \beta_1 Mow+ \beta_2  Warm$
\item Interaction: $Terminal Velocity = \beta_0 + \beta_1 Mow+ \beta_2 Warm + \beta_3 Warm \cdot Mow $
\end{itemize}

We use model *p*-values for the mowing only and warming only models to establish which provide a better fit for the data. Then, with the better fitting model as a base, we perform a partial *F*-test to identify whether additional variables significantly improve model fit. Second, to validate the results of the partial *F*-test, we evaluate both the AIC and BIC for each model. 

```{r ByTreatment_ANOVA_log, include = FALSE}
# Warming
mod.warm.log <- lm(log(TV) ~ Warming, data = data.new)
summary(mod.warm.log)
F.warm <- summary((mod.warm.log))$fstatistic

# Early vs. late mowing 
mod.mow.log <- lm(log(TV) ~ Mow, data = data.new)
summary(mod.mow.log)
F.mow <- summary((mod.mow.log))$fstatistic

# No interaction (E/L mow)
mod.mowWarm.log <- lm(log(TV) ~ Mow + Warming, data = data.new)
summary(mod.mowWarm.log)

# Interaction (E/L mow)
mod.int.log <- lm(log(TV) ~ Mow + Warming + Mow:Warming, data = data.new)
summary(mod.int.log)
#anova(mod.int.log)

```

Here, the warming only model has a *p*-value of ```r round(pf(F.warm[1],F.warm[2],F.warm[3],lower.tail=F),4)``` whereas the mowing only model has a *p*-value of ```r  round(pf(F.mow[1],F.mow[2],F.mow[3],lower.tail=F),4)```. Therefore, we use the warming only model as the base model in our partial *F*-test. Results, shown in Table \ref{tab:TV_ANOVAResults}, suggest that the warming and mowing model is the best fit for the data.

Like the partial *F*-test, both AIC and BIC support the warming and mowing model (Table \ref{tab:TV_AIC}). Thus, we conclude that the warming and mowing model is the best fit for the log-transformed terminal velocity data.

```{r TV_ANOVAResults}
tab.dat <- anova(mod.warm.log, mod.mowWarm.log, mod.int.log)
tab.dat <- data.frame(Model = c("Warming Only", "Warming and Mowing", "Interaction"), 
                     "P-Value" = round(tab.dat[, "Pr(>F)"], 4))
kable(tab.dat, caption = "\\label{tab:TV_ANOVAResults} Results of partial $F$-test comparing three models for
                          predicting terminal velocity.")
```

```{r TV_AIC}
AIC <- data.frame(Model = c("Mowing Only","Warming Only", "Warming and Mowing", "Interaction"), 
                  AIC = c(AIC(mod.mow.log), AIC(mod.mow.log), AIC(mod.mowWarm.log), AIC(mod.int.log)), 
                  BIC = c(AIC(mod.mow.log, k = log(length(data.new))), AIC(mod.mow.log, k = log(length(data.new))), AIC(mod.mowWarm.log, k = log(length(data.new))), AIC(mod.int.log, k = log(length(data.new)))))
AIC[2,3] <- round(AIC[2,3],2)
kable(AIC, caption = "\\label{tab:TV_AIC} AIC and BIC values for each model.")
```

The residuals for the warming and mowing model are shown in Figure \ref{fig:TV_Resids}. There do not appear to be any obvious patterns in the residuals, and though there are a few points with high leverage, they are not extremely influential according to Cook's distance. Lastly, it is evident that log-transformation significantly improves the normality of the errors, as can be seen in the Normal Q-Q plot. 

```{r TV_Resids, fig.height = 14, fig.width = 12, fig.cap = "\\label{fig:TV_Resids}Diagnostic plots for warming and mowing model."}
par(mfrow = c(2,2))
plot(mod.mowWarm.log, cex.lab = 1.5, cex.axis = 1.3)
```

Model results are shown in Table \ref{tab:TV_ModelResults} and treatment level predictions are shown in Figure \ref{fig:TV_ANOVATrtEst}. From these results, we conclude that early mowing significnatly decreases terminal velocity, whereas warming increases terminal velocity. 

```{r TV_ModelResults}
df = round(summary(mod.mowWarm.log)$coefficients[,c(1,4)],2)
df[,1] = paste(df[,1], " (", round(confint(mod.mowWarm.log)[,1],2),", ",round(confint(mod.mowWarm.log)[,2],2),")", sep = "")
kable(df, caption = "\\label{tab:TV_ModelResults}Estimated coefficients and  $p$-values for warming and mowing model. 95% confidence interval shown in parenthesis.")
```

```{r TV_ANOVATrtEst, fig.height = 5, fig.width = 9, fig.cap="\\label{fig:TV_ANOVATrtEst}Results of best fitting ANOVA model, which included both warming and mowing as predictors. Square dots show mean predicted value and error bars show 95% confidence intervals."}
mowWarm.dat = expand.grid(Mow = c("CTL", "E", "L"), Warming = c("A", "W"))
mowWarm.dat = cbind(mowWarm.dat, predict(mod.mowWarm.log, newdata = mowWarm.dat, interval = "confidence"))
mowWarm.dat = do.call(data.frame, mowWarm.dat)

ggplot(data = mowWarm.dat, aes(x = Mow, color = Warming))+
  geom_point(aes(y = fit), position = position_dodge(0.5), size = 2, shape = 15)+
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2, position = position_dodge(0.5))+
  labs(y = "Estimated log(Terminal Velocity)")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

# Research Question 3

Finally, we are also interested in exploring the extent to which the results of Research Question 2, or the changes in seed terminal velocity by treatment, can be explained by changes in seed pappus width. We are investigating pappus width specifically because the results of Research Question 1 show that it is a good predictor of terminal velocity. Figure \ref{fig:SWbarplot} shows the variation in pappus width across treatments. 

```{r SWbarplot, fig.height = 5, fig.width = 9, fig.cap="\\label{fig:SWbarplot} Seed pappus width by warming and mowing treatments. Height of bar shows group mean, and error bars show one standard error. Actual data shown with black dots."}
barplot.dat = aggregate(data.new$SeedWidth, by = list(Mowing = data.new$MowYN, Warming = data.new$Warming), FUN = function(x) c(mean(x),sd = sd(x), n = length(x)))
barplot.dat = do.call(data.frame, barplot.dat)
barplot.dat$SE = barplot.dat$x.sd / sqrt(barplot.dat$x.n)
colnames(barplot.dat) = c("Mowing", "Warming", "Mean", "SD", "n", "SE")
barplot.dat$Mowing = ifelse(barplot.dat$Mowing == 1, "Y","N")

ggplot(data = barplot.dat, aes(Mowing, Mean, fill = Warming))+
  geom_bar(stat = "identity", position = position_dodge(0.9))+
  geom_point(data = data.new, aes(x = ifelse(MowYN == 1, "Y", "N"), group = Warming, y = SeedWidth), position = position_jitterdodge(dodge.width = 0.9), alpha = 0.5, shape = 16)+
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2, position = position_dodge(0.9))+
  labs(y = "Seed Pappus Width (mm)")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

The data fitting methods used to address this question are similar to those of Research Question 2. We use partial *F*-tests and AIC/BIC analyses for model selection, but do not transform our response variable. First, we attempt to find the best fit of the four basic models: mowing only, warming only, warming and mowing, and interaction. 

```{r SW_ANOVA, include = FALSE}
# warming
SW.warm = lm(SeedWidth ~ Warming, data= data.new)
summary(SW.warm)
F.warm = summary((SW.warm))$fstatistic

# early vs. late mowing 
SW.mow = lm(SeedWidth ~ Mow, data= data.new)
summary(SW.mow)
F.mow = summary((SW.mow))$fstatistic

# no interaction (E/L mow)
SW.mowWarm = lm(SeedWidth ~ Mow + Warming, data = data.new)
summary(SW.mowWarm)

# interaction (E/L mow)
SW.int = lm(SeedWidth ~ Mow + Warming + Mow:Warming, data= data.new)
summary(SW.int)
#anova(mod.int.log)
```

Here, the warming only model has a *p*-value of ```r round( pf(F.warm[1],F.warm[2],F.warm[3],lower.tail=F),4)``` whereas the mowing only model has a *p*-value of ```r  round(pf(F.mow[1],F.mow[2],F.mow[3],lower.tail=F),4)```. Therefore, we use the mowing only model as the base model in our partial *F*-test. Results suggest that the warming and mowing model is again the best fit for the data (Table \ref{tab:SW_ANOVAResults}). 

```{r SW_ANOVAResults}
tab.dat = anova(SW.mow, SW.mowWarm, SW.int)
tab.dat = data.frame(Model = c("Mowing Only", "Warming and Mowing", "Interaction"), "P-Value" = round(tab.dat[,"Pr(>F)"],4))
kable(tab.dat, caption = "\\label{tab:SW_ANOVAResults}Results of partial $F$-test for models predicting seed pappus width by treatment.")
```

Again, we use AIC and BIC model selection criteria to validate these results. Table \ref{tab:SW_AIC} shows similar results to those in Research Question 2, suggesting that the warming and mowing model is the best fit.

```{r SW_AIC}
AIC = data.frame(Model =  c("Mowing Only","Warming Only", "Warming and Mowing", "Interaction"), AIC = c(AIC(SW.mow), AIC(SW.warm), AIC(SW.mowWarm), AIC(SW.int)), BIC = c(AIC(SW.mow, k = log(length(data.new))), AIC(SW.warm,k = log(length(data.new))), AIC(SW.mowWarm, k = log(length(data.new))), AIC(SW.int,k = log(length(data.new)))))
AIC[2,3] = round(AIC[2,3],2)

kable(AIC, caption = "\\label{tab:SW_AIC} AIC and BIC values for each of the four models predicting seed pappus width.")
```

Thus, both the partial *F*-test and the AIC/BIC values support the warming and mowing model, whose model diagnostic plots are shown in Figure \ref{fig:SW_Resids}. These residuals suggest the errors are approximately normally distributed. Again, there may be a few leverage points, though they do not have high influence. 

```{r SW_Resids, fig.height = 14, fig.width = 12, fig.cap="\\label{fig:SW_Resids}Diagnostic plots for predicting seed pappus width using warming and mowing model."}
par(mfrow = c(2,2))
plot(SW.mowWarm, cex.lab = 1.5, cex.axis = 1.3)
```

Table \ref{tab:SW_ModelResults} shows the results of the warming and mowing model for predicting seed pappus width. These results suggest that both early mowing, late mowing, and warming signficantly decrease pappus width. 

```{r SW_ModelResults}
df = round(summary(SW.mowWarm)$coefficients[,c(1,4)],2)
df[,1] = paste(df[,1], " (", round(confint(SW.mowWarm)[,1],2),", ",round(confint(SW.mowWarm)[,2],2),")", sep = "")
kable(df, caption = "\\label{tab:SW_ModelResults} Results of Warming and Mowing model for predicting seed pappus width. Coefficient estiamtes, 95% confidence intervals and $p$-values are shown.")
```

To investigate the pairwise comparisons between each group, we performed a post-hoc Tukey HSD test (Figure \ref{fig:SW_Tukey}). The results from this test suggest that there are two major groups which emerge: (1) non-mowed, control plants regardless of whether they were warmed and (2) warmed plants that were mowed, regardless of the timing of the mowing. Because the timing of the mowing does not appear to be a significant factor in determining pappus width, we fit a second model predicting pappus width based on warming and a binary mowing variable.  

```{r SWbin_ANOVA, include = FALSE}
# warming
SWbin.warm = lm(SeedWidth ~ Warming, data= data.new)
summary(SWbin.warm)
F.warm = summary((SWbin.warm))$fstatistic

# early vs. late mowing 
SWbin.mow = lm(SeedWidth ~ MowYN, data= data.new)
summary(SWbin.mow)
F.mow = summary((SWbin.mow))$fstatistic

# no interaction (E/L mow)
SWbin.mowWarm = lm(SeedWidth ~ MowYN + Warming, data = data.new)
summary(SWbin.mowWarm)

# interaction (E/L mow)
SWbin.int = lm(SeedWidth ~ MowYN + Warming + MowYN:Warming, data= data.new)
summary(SWbin.int)
#anova(mod.int.log)
```

```{r SWbin_ANOVAResults}
tab.dat = anova(SWbin.mow, SWbin.mowWarm, SWbin.int)
tab.dat = data.frame(Model = c("Warming Only", "Warming and Mowing", "Interaction"), "P-Value" = round(tab.dat[,"Pr(>F)"], 4))
kable(tab.dat, caption = "\\label{tab:SWbin_ANOVAResults}Results of partial $F$-test performed for models predicting seed pappus width using warming and binary mowing predictors.")
```

```{r SWbin_AIC}
AIC = data.frame(Model =  c("Mowing Only","Warming Only", "Warming and Mowing", "Interaction"), AIC = c(AIC(SWbin.mow), AIC(SWbin.warm), AIC(SWbin.mowWarm), AIC(SWbin.int)), BIC = c(AIC(SWbin.mow, k = log(length(data.new))), AIC(SWbin.warm,k = log(length(data.new))), AIC(SWbin.mowWarm, k = log(length(data.new))), AIC(SWbin.int,k = log(length(data.new)))))
AIC[2,3] = round(AIC[2,3],2)
kable(AIC, caption = "\\label{tab:SWbin_AIC}AIC and BIC for models predicting seed pappus width using warming and binary mowing predictors.")
```

Discerning between the warming and mowing and the interaction models is less clear in this case. On one hand, the partial *F*-test suggests the interaction model may provide a slightly better fit (Table \ref{tab:SWbin_ANOVAResults}) and the interaction model has the lowest AIC value (Table \ref{tab:SWbin_AIC}), but the warming and mowing model has the lowest BIC value (Table \ref{tab:SWbin_AIC}). This result is consistent with our expectations, as a slight improvement in model fit may not be enough to overcome the BIC penalty for an additional term in the interaction model. 

The results of both models are summarized in Table \ref{tab:SWbin_ModelResults}. In the warming and mowing model, both treatments decrease pappus width; whereas when an interaction term is added, neither the warming nor mowing terms are significant, but the interaction term itself becomes significant at $\alpha = 0.1$.  

```{r SWbin_ModelResults}
df1 = round(summary(SWbin.mowWarm)$coefficients[,c(1,4)],4)
rownames(df1) = c("Intercept", "Mow", "Warm")
df2 = round(summary(SWbin.int)$coefficients[,c(1,4)],4)
rownames(df2) = c("Intercept", "Mow", "Warm", "Mow:Warm")
df = cbind(rbind(df1,rep(NA,times = 2)), df2)
rownames(df) = c("Intercept", "Mow", "Warm", "Mow:Warm")
colnames(df) = c("Warming and Mowing Estimate", "Pr(>|t|)", "Interaction Estimate", "Pr(>|t|)")
df[,1] = paste(df[,1], " (", round(confint(SWbin.mowWarm)[,1],2),", ",round(confint(SWbin.mowWarm)[,2],2),")", sep = "")
df[,3] = paste(df[,3], " (", round(confint(SWbin.int)[,1],2),", ",round(confint(SWbin.int)[,2],2),")", sep = "")
df[4,1]=  NA
kable(df, caption = "\\label{tab:SWbin_ModelResults}Results of warming and mowing and interaction models, respectively.")
```

These two results suggest that plants which are both warmed and mowed have smaller pappus width. Plants which are both warmed and mowed are likely driving the significant mowing and warming coefficients we see in the warming and mowing model. Another post-hoc Tukey test, shown in Figure \ref{fig:SWbin_Tukey}, supports this conclusion. 

```{r SW_Tukey, fig.width = 7, fig.height = 4, fig.cap = "\\label{fig:SW_Tukey}Results of post-hoc Tukey HSD test. Letters indicate groups which are significantly different, where 0.05 is the significance level. Notation is as follows: CTL - no mowing, E - early mowing, L - late mowing; A - ambient (i.e. no warming), W - warming"}
out = HSD.test(aov(SeedWidth ~ Mow + Warming + Mow:Warming, data= data.new), c("Mow","Warming"))
bar.group(out$groups, ylim = c(0,25), xlab = "Mowing", ylab = "Seed Pappus Width (mm)", main = "Tukey HSD")
```

```{r SWbin_Tukey, fig.width = 7, fig.height = 4, fig.cap="\\label{fig:SWbin_Tukey}Results of post-hoc Tukey HSD test. Letters indicate groups which are significantly different, where 0.05 is the significance level. Notation is as follows: CTL - no mowing, M - mowing; A - ambient (i.e. no warming), W - warming"}
out = HSD.test(aov(SeedWidth ~ MowYN + Warming + MowYN:Warming, data= data.new), c("MowYN","Warming"))
rownames(out$groups) = c("CTL:A", "CTL:W", "M:A", "M:W")
bar.group(out$groups, ylim = c(0,25), xlab = "Mowing", ylab = "Seed Pappus Width (mm)", main = "Tukey HSD")
```

# Discussion

The results of this experiment contribute to our understanding of how *Carduus nutans*  may spread under future climates, and further how mowing management may mediate these changes. We found that, as predicted by physical models$^4$, the width of the seed is a good predictor of terminal velocity. Smaller seeds fall faster, and thus disperse shorter distances. 

Theoretical$^5$ and experimental$^6$ results suggest that plants under stress will disperse farther, and our results are consistent with this idea. We showed that early mowing decreased terminal velocity, which means, with all else equal, these mowed plants will disperse further. Understanding the effect of late mowing on seed terminal velocity was difficult because many of the late mowed plants died. Fewer data points paired with small effect sizes for late mowed plant terminal velocity created wide confidence intervals and high p-values. Quantifying such  terminal velocity changes in late-mowed plants may require a study with more replication to ensure sufficient statistical power after plant mortality due to late mowing. 

We also found that warming increased terminal velocity. In this case, all else being equal, we would expect seeds to disperse less far. However, previous work in our lab$^7$ showed that warmed thistles reach taller heights. Given a fixed terminal velocity, seeds of taller plants are expected to disperse further. Thus, an increase in terminal velocity of warmed plants does not necessarily translate directly into less dispersal and spread. Further modeling, that includes changes in plant height as well as changes in terminal velocity, will quantify overall changes in thistle spread. 
 
We showed that plants which were both warmed and mowed had smaller seed pappus width. Based on our model which describes terminal velocity as a function of seed pappus width (Research Question 1), we expect these warmed and mowed plants to have higher terminal velocity and, therefore, to disperse less far. Yet, in our analysis of changes in terminal velocity by treatment (Research Question 2), we showed mowing decreased terminal velocity. These discrepencies suggest that treatment level changes in seed terminal velcotiy cannot be fully explained by changes in seed pappus width. 

This data set is lacking seed mass data, which may be responsible for the inconsistencies we observed. Seed mass is a second physical property needed to predict terminal velocity$^4$ and may also change with warming and mowing. Lacking seed mass data limits our ability to explain changes in seed terminal velocity through physical properties of the seed. However, our results which quantify the effect of the treatments on terminal velocity are unaffected, Further studies which measure both seed pappus width and seed mass will be necessary to  explain  physical and biological mechanisms which explain the observed changes in terminal velocity. 

# References
1. US National Plant Germplasm System. Website  [npgsweb.ars-grin.gov](https://npgsweb.ars-grin.gov/gringlobal/taxonomydetail.aspx?id=104109) accessed 10 December 2019.
2. USDA Natural Resources Conservation Service. Website [plants.usda.gov](https://plants.usda.gov/core/profile?symbol=CANU4) accessed 10 December 2019.
3. Katul *et al.* 2005. *American Naturalist*, 166(3), pp. 368-381. 
4. Skarpaas and Shea 2007. *American Naturalist*, 170(3), pp. 421-430. 
5. Levin *et al.* 2003. *Annual Review of Ecology, Evolution, and Systematics*, 34(1), pp. 575-604.
6. Teller *et al.* 2014. *Ecology*, 95(10), pp. 2694-2698.
7. Keller *et al.*, in prep.