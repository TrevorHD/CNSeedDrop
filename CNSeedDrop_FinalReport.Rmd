---
title: "Final Project Report"
author: "Trevor Drees and Emily Howerton"
date: "December 15, 2019"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: no
    fig_height: 4
    fig_width: 5
editor_options: 
  chunk_output_type: console
header-includes:
- \usepackage{float}
- \usepackage[width=0.8\textwidth]{caption}
urlcolor: blue
---

```{r setup, include = FALSE}

# Load packages
library(knitr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
#library(agricolae)
library(MASS)
library(maditr)
library(corrplot)
library(leaps)
library(car)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.pos = 'H')
options(knitr.kable.NA = "")



#Initialise data
data <- read.csv("https://raw.githubusercontent.com/TrevorHD/CNSeedDrop/master/SeedDropData.csv")

# Treating pappus as cone-shaped, calculate vertex angle, base area, volume, and height
# Also calculate terminal velocity given drop time and fixed drop height
data %>% mutate(SeedAngle = acos(1 - ((SeedWidth^2)/(2*(SeedLength^2)))),
                SeedArea = pi*((SeedWidth/2)^2),
                SeedHeight = sqrt(SeedLength^2 - (SeedWidth/2)^2),
                SeedVol = (pi/3)*((SeedWidth/2)^2)*SeedHeight,
                TV = 1.25/DT.Avg) -> data

# Create new data set that excludes instances where pappus length, width, or DT are NA
data.new <- data[complete.cases(data[ , 23:25]), ]

# Need unique plot indicators by block - plot 1 and plot 2 are not similar in any way across blocks
data.new$PlotUnique = as.factor(paste(data.new$Block,"_",data.new$Plot))
# use PlantID for position

# Create a mowing y/n flag
data.new$MowYN = ifelse(data.new$Mow == "CTL", 0, 1)
```

# Abstract

# Introduction and Data

As the world has become significantly more interconnected, the increased movement of people across the world has also facilitated an increase in the spread of species outside of their native ranges. When species that are introduced outside of their native range become invasive, they can have a detrimental impact on local biodiversity, quantity and quality of valuable ecosystem services, and other aspects of the local ecosystem. Because of this, the study of invasive species has been a large part of the ecology literature in recent decades, ranging from theoretical models of how they spread to investigating possible management practices that keep them at bay.

One particular invasive species that has greatly expanded its range due to human activity is *Carduus nutans*, also known as "musk thistle" or "nodding thistle". This thistle is native to Europe and Central Asia, but has expanded its range into North America, Australia, and New Zealand, among other parts of the world$^1$. Within the U.S., this thistle has been reported in all U.S. states except for Alaska, Florida, Hawaii, Maine, and Vermont$^2$; the thistle may even be present in these states, but has not yet been reported. It is also been reported all Canadian provinces except Nunavut, Northwest Territories, and Yukon Territories$^2$.
  
*C. nutans* is considered to be a noxious weed in many U.S. states for several reasons. Because it can occur in very large numbers and grow to be quite large, this thistle may form dense and often impenetrable stands. The plant is also covered in numerous large spines, making it painful when touched as well as unpalatable to grazing animals. The adverse impacts of this weed on grazing can also lead to substantial economic losses.

Another reason why there is concern over *C. nutans* is because it has a high potential to spread locally when introduced, as it is wind dispersed and large pappi on the seeds allow them to be transported great distances. Models have been proposed to model such wind-driven seed dispersal$^3$, and such models have been applied to *C. nutans*$^4$, showing significant potential for long-range dispersal events. While there are abiotic and biotic factors that affect how far a seed like those in *C. nutans* can be dispersed, a noteworthy predictor of dispersal distance is seed terminal velocity. For seeds, a higher terminal velocity generally means a decreased dispersal distance; this is because a higher terminal velocity means the seed falls faster and thus spends less time in the air, which means less of an opportunity for wind to carry it further from its source.

However, it is not entirely clear what affects terminal velocity in *C. nutans* seeds, though the most obvious candidates would be physical properties of the seed such as shape and mass. In general, seeds with a larger area perpendicular to the direction of motion will have higher drag and a lower terminal velocity. Seeds with a higher mass will have a higher downward force (*mg*) from gravity and thus a higher air resistance force that must equal it to achieve terminal velocity, which leads to a higher terminal velocity since said resistance force is proportional to that velocity. However, the physical properties of the seed may be affected by the morphology and physiology of the parent plant; abiotic and biotic factors can affect the parent plant in such a way that may ultimately influence the terminal velocity of its seeds.

Given that there may be a link between abiotic influences on *C. nutans* and the terminal velocity of its seeds, we wish to investigate whether certain treatments applied to the plant before it flowers have any effect on seed dispersal capabilities. Any treatment effects that can reduce the dispersal capability of these thistles may then be used to inform management decisions. By using mowing treatments as well as warming treatments (and combinations of the two), we will examine the effects of said treatments on seed terminal velocity and thus on dispersal capability.

The data used to assess the effects of mowing and warming on seed terminal velocity were collected during a field experiment that involved applying these treatments to parent plants and collecting their flower heads aftey they had set seed. The experimental setup involves ten blocks, with each block containing two plots: one plot with a warming treatment and one without. Within each plot there are three positions: one with an early mowing treatment, one with a late mowing treatment, and one with no mowing at all. Overall, this yields six unique combinations of warming and mowing, with 10 replicates for each combination. Ten seeds were planted at each position, and one flower head was harvested from all individuals that survived to harvest date. Seeds were collected from individual flower heads and their terminal velocities were determined by timing the amount of time it took them to afll through a 1.25-m drop chamber. For each seed, these drop tests were repeated until two consecutive drop times were recorded within 0.1 seconds of each other.

Using the data from the experiment described above, we seek answers to three research questions of interest:

\begin{enumerate}
\item Is seed terminal velocity predicted by seed shape parameters?
\item To what extent do warming and mowing treatments change seed terminal velocity?
\item Can changes in terminal velocity by treatment be explained by changes in seed shape parameters?
\end{enumerate}

# Research Question 1 

``` {r}
# Remove any rows where the quantities defined above are NaN
data.new <- data.new[-which(is.nan(data.new[, 36])), ]
```

Before any models were fit to the data, we first examined correlations between the various seed physical properties. The `pairs` plot for terminal velocity and the various physical properties is shown below:

``` {r}
pairs(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")])
```

Linear correlations between the variables can also be shown in a heatmap of the correlation matrix:

``` {r}
corrplot(cor(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")]),
         method = "square", type = "upper")
```

Between both of these plots, it is clear that multicollinearity will be an issue since several of the variables are highly correlated with each other (e.g. `SeedWidth` and `SeedAngle`, `SeedWidth` and `SeedArea`, etc.). 

Our first model used the terminal veocity `TV` as a response and each of the physical properties as predictors. The resulting coefficients and their significance are listed below:

``` {r}
mod.full <- lm(TV ~ SeedWidth + SeedLength + SeedArea + SeedAngle + SeedHeight + 
                    SeedVol, data = data.new)
mod.full.out <- as.data.frame(cbind(round(summary(mod.full)$coefficients, digits = 4),
                                    c(NA, round(vif(mod.full), digits = 4)),
                                    c("***", "**", ".", "", "", "", "*")))
dimnames(mod.full.out)[[2]] <- c("Estimate", "Std. Error", "t value", "Pr(>|t|)",
                                 "VIF", "Significance")
kable(mod.full.out, align = "r")
```

It is clear that this model is a poor fit for two main reasons. First, many of the terms are not significant to $\alpha = 0.05$ and add no significant additional predictive power to the model. Second, the VIF for all of the coefficients is quite high, as was predicted.

Given that some of these variables must be removed to improve the fit of the model, we then performed variable selection on the full model to reduce clutter. The first method of selection was backwards selection from the full model; this involved removing subsequent variables based on their *p*-value; the variable with the highest *p*-value was removed, the resulting model examined, and the process repeated until all predictors were significant. The second method of selection involved backwards selection from the full model using AIC, where terms were removed until the AIC of the model was minimised. The third mehtod of selection started from the full model and used `step` selection in both directions, while the fourth method started from the null model and added terms; again, in both cases, the selection continued until the AIC of the model was minimised.

``` {r, include = FALSE}
# Backward elimination, no AIC or BIC; remove "worst" predictor
mod.1 <- update(mod.full, . ~ . - SeedAngle)
summary(mod.1)
mod.1 <- update(mod.1, . ~ . - SeedArea)
summary(mod.1)

# Backward elimination with AIC produces the exact same result
step(mod.full, direction = "backward", data = data.new)

# Step in both directions with AIC produces the exact same result
step(mod.full, direction = "both", data = data.new)

# Forward selection with AIC
mod.null <- lm(TV ~ 1, data = data.new)
step(mod.null, direction = "forward", scope = list(lower = mod.null, upper = mod.full), data = data.new)
mod.2 <- lm(TV ~ SeedWidth + SeedArea, data = data.new)
summary(mod.2)
```

The results from the model selection can be seen below, along with the VIF for each term as well as both the AIC and $R^2$ for each resulting model. All coefficients are significant to $\alpha < 0.001$.

``` {r}
mod.1.out <- cbind(c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
                   c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
                   c(summary(mod.1)$coefficients[1:3, 1], rep(NA, 2), summary(mod.1)$coefficients[4:5, 1]),
                   c(summary(mod.2)$coefficients[1:2, 1], NA, summary(mod.1)$coefficients[4, 1], rep(NA, 3)),
                   c(NA, vif(mod.1)[1:2], rep(NA, 2), vif(mod.1)[3:4]),
                   c(NA, vif(mod.2)[1], NA, vif(mod.2)[2], rep(NA, 3)))
mod.1.out <- rbind(mod.1.out, c(rep(-1293.6, 3), -1288.4),
                              c(rep(summary(mod.1)$adj.r.squared, 3), summary(mod.2)$adj.r.squared))
dimnames(mod.1.out)[[1]] <- c(dimnames(mod.full.out)[[1]], "AIC", "R^2")
dimnames(mod.1.out)[[2]] <- c("Method 1", "Method 2", "Method 3", "Method 4", "Method 1,2,3 VIF", "Method 4 VIF")
kable(mod.1.out, align = "r")

```

As we can see in the table, the first three selection methods produced the exact same result, while the fourth method produced a result with fewer terms. While the model derived from the first three methods has a higher $R^2$ and lower AIC than the model derived from the fourth method, it suffers greatly from high VIC. Because the VIF on the second model is much lower that that of the first and the difference in $R^2$ is very small, we will proceed with the second model, effectively trading a small increase in the amount of unexplained variance for a large decrease in multicollinearity.

``` {r, include = FALSE}
mod.3 <- lm(TV ~ SeedWidth, data = data.new)
anova(mod.2, mod.3)
```

However, we still see a rather high VIF for the `SeedWidth` and `SeedArea` terms. While the `SeedArea` term may be inflating estimates when added to `SeedWidth`, a partial *F*-test confirms that its addition is statistically significant (*F* = 32.43, *p* < 0.001). Since `SeedArea` is proportional to the square of `SeedWidth`, we can simply express it as such in a polynomial regression instead of using a separate `SeedArea` variable for it.

``` {r}
mod.4 <- lm(TV ~ SeedWidth + I(SeedWidth^2), data = data.new)
```

Comparing this to a single-term model where VIF is not an issue, we see that a model with only `SeedWidth` is not as good of a fit, with an $R^2$ of 0.3274 compared to 0.3804 for the quadratic model. This is also clear when plotting the models against the data, as can be see below:

``` {r, include = FALSE}
summary(mod.3)
summary(mod.4)
```

We can also compare the distribution of residuals between the two models to check their validity. As can be seen below, the residuals are approximately normally-distributed for both models, with a bit of deviation from normality at the tails of the distribution.

``` {r}
plot(TV ~ SeedWidth, data = data.new)
testdata <- data.frame(SeedWidth = seq(min(data.new$SeedWidth), max(data.new$SeedWidth), length.out = 300))
testdata$TV = predict(mod.4, newdata = testdata)
with(testdata, lines(x = SeedWidth, y = TV, col = "chocolate1", lwd = 2))
abline(mod.3, col = "deepskyblue", lwd = 2)
remove(testdata)
```

However, there are clearly differences regarding patterns of distribution in the residuals. For the model with only `SeedWidth`, there appears to be some curvature in the distribution of residuals, suggesting that an invalid model has been fit to the data. However, in the model with both linear and quadratic `SeedWidth` terms, the curved pattern in the residuals disappears, suggesting that this model is more valid.

``` {r, fig.height = 14, fig.width = 12}
par(mfrow = c(2, 1))
plot(mod.3, which = 2, cex.lab = 1.6, cex.axis = 1.4, main = NA)
plot(mod.4, which = 2, cex.lab = 1.6, cex.axis = 1.4, main = NA)
```

``` {r, fig.height = 14, fig.width = 12}
par(mfrow = c(2, 1))
plot(mod.3, which = 1, cex.lab = 1.6, cex.axis = 1.4, main = NA)
plot(mod.4, which = 1, cex.lab = 1.6, cex.axis = 1.4, main = NA)
```

``` {r, fig.height = 14, fig.width = 12}
par(mfrow = c(2, 1))
plot(rstandard(mod.3) ~ SeedWidth, data = data.new, ylab = "Standardised Residuals")
abline(h = 0, col = "red")
abline(h = c(-2, 2), col = "red", lty = 3)
plot(rstandard(mod.4) ~ SeedWidth, data = data.new, ylab = "Standardised Residuals")
abline(h = 0, col = "red")
abline(h = c(-2, 2), col = "red", lty = 3)
```

# Research Question 2

Not only are we interested in predicting seed terminal velocity based on the physical properties of the seed, we are also interested in quantifying the extent to which two environmental variables, warming and mowing, affect seed terminal velocity.  Figure \ref{fig:TVbarplot} shows variation in termnal velocity across all six treatments. Using this plot, we can generate a preliminary hypothesis that warming increases terminal velocity, while mowing decreases it. The following analyses will determine whether such differences are statistically significant. As we can also see in Figure \ref{fig:TVbarplot}, there are fewer points for late mowed plants, as many of them died due to mowing late in the life cycle of the plant.  

```{r TVbarplot,fig.cap="\\label{fig:TVbarplot}Terminal velocity for plants grown under warming and mowing treatments. Height of bar shows group mean, and error bars show one standard error. Actual data shown with black dots."}
barplot.dat = aggregate(data.new$TV, by = list(Mowing = data.new$Mow, Warming = data.new$Warming), FUN = function(x) c(mean(x),sd = sd(x), n = length(x)))
barplot.dat = do.call(data.frame, barplot.dat)
barplot.dat$SE = barplot.dat$x.sd / sqrt(barplot.dat$x.n)
colnames(barplot.dat) = c("Mowing", "Warming", "Mean", "SD", "n", "SE")

ggplot(data = barplot.dat, aes(Mowing, Mean, fill = Warming))+
  geom_bar(stat = "identity", position = position_dodge(0.9))+
  geom_point(data = data.new, aes(x = Mow, group = Warming, y = TV), position = position_jitterdodge(dodge.width = 0.9), alpha = 0.5, shape = 16)+
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2, position = position_dodge(0.9))+
  labs(y = "Terminal Velocity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


Because we are fitting a continutous response variable to categorical predictor variables, we will use an ANOVA model to characterize changes in terminal velocity by treatmnet.We log-transformed terminal velocity to compensate for skewed right distribution of the terminal velocity data and significant deviations from error normality, as seen in Figure \ref{fig:TVHistAndErrors}. 

```{r TVHistAndErrors,fig.cap="\\label{fig:TVHistAndErrors} Justification for transofmraiton of terminal velocity. Histogram of terminal velocity (A) and Normal-QQ plot of linear model with both warming and mowing predictors (B)."}

# show TV histogram
p1 = ggplot(data = data.new)+
  geom_histogram(aes(TV), fill = "white", color = "black", bins = 10)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x = "Terminal Velocity", y = "Count", tag = "A")
# show residuals 
mod.TV = lm(TV ~ Warming + Mow, data = data.new)
resid = as.data.frame(mod.TV$residuals)
colnames(resid) = c("Residuals")
p2 = ggplot(resid, aes(sample = Residuals))+
  stat_qq() + 
  stat_qq_line()+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x = "Theoretical", y = "Sample", tag = "B")
grid.arrange(p1, p2, nrow = 1)

```


Using log-transformed terminal velocity, we use two methods to identify the most appropriate model. First, we fit the following four models:

\begin{itemize}
\item Mowing Only: $Terminal Velcotiy = \beta_0 + \beta_1 Mow$
\item Warming Only: $Terminal Velocity = \beta_0  + \beta_1 Warm$
\item Warming and Mowing: $Terminal Velocity = \beta_0 + \beta_1 Mow+ \beta_2  Warm$
\item Interaction: $Terminal Velocity = \beta_0 + \beta_1 Mow+ \beta_2 Warm + \beta_3 Warm \cdot Mow $
\end{itemize}

We used model p-values for the Mowing and Warming only models to establish which provided a better fit for the data. Then, using this better fitting model as a base, we performed a partial F-test to identify whether adding additional variables to the model significantly improved model fit.

```{r ByTreatment_ANOVA_log, include = FALSE}
# warming
mod.warm.log = lm(log(TV) ~ Warming, data= data.new)
summary(mod.warm.log)
F.warm = summary((mod.warm.log))$fstatistic

# early vs. late mowing 
mod.mow.log = lm(log(TV) ~ Mow, data= data.new)
summary(mod.mow.log)
F.mow = summary((mod.mow.log))$fstatistic

# no interaction (E/L mow)
mod.mowWarm.log = lm(log(TV) ~ Mow + Warming, data = data.new)
summary(mod.mowWarm.log)

# interaction (E/L mow)
mod.int.log = lm(log(TV) ~ Mow + Warming + Mow:Warming, data= data.new)
summary(mod.int.log)
#anova(mod.int.log)

```

Here, the warming only model has a p-value of ```r round( pf(F.warm[1],F.warm[2],F.warm[3],lower.tail=F),4)``` whereas the mowing only model has a p-value of ```r  round(pf(F.mow[1],F.mow[2],F.mow[3],lower.tail=F),4)```. Therefore, we use the warming only model as the base model in our partial F-test. Results, shown in the table below, suggest that the model with both mowing and warming, but no interaction term is the best fit for the data. 

```{r TV_ANOVAResults}
tab.dat = anova(mod.warm.log, mod.mowWarm.log, mod.int.log)
tab.dat = data.frame(Model = c("Warming", "Mowing and Warming", "Interaction"), "P-Value" = round(tab.dat[,"Pr(>F)"],4))
kable(tab.dat)
```

To validate these model selection results, we also performed model selection with both AIC and BIC; the results are shown in the table below. 

```{r TV_ModelSelection, include = FALSE}
fit.TV = lm(log(TV) ~ Warming * Mow, data = data.new)
fitTV.select = list()
#AIC
fitTV.select$AICBoth = stepAIC(fit.TV, direction = "both")
fitTV.select$AICBackward = stepAIC(fit.TV, direction =  "backward")
fitTV.select$AICForward = stepAIC(lm(log(TV)~1, data = data.new), direction =  "forward")
#BIC
fitTV.select$BICBoth = stepAIC(fit.TV, direction = "both", k = log(length(data.new)))
fitTV.select$BICBackward = stepAIC(fit.TV, direction =  "backward", k = log(length(data.new)))
fitTV.select$BICForward = stepAIC(lm(log(TV)~1, data = data.new), direction =  "forward", k = log(length(data.new)))
```

```{r TV_ModelSelectionTable, fig.cap="\\label{fig:TV_ModelSelectionTable}CAPTION"}
# results of model selection
TV.selection = expand.grid(Variable = c("(Intercept)","MowE","WarmingW", "WarmingW:MowE"), Method = c("AICForward", "AICBackward", "AICBoth", "BICForward", "BICBackward", "BICBoth"))
#TV.selection$Method = c("AIC: Forward", "AIC: Backward", "AIC: Bi-directional", "BIC: Forward", "BIC: Backward", "BIC: Bi-directional")
#TV.selection$Variable = c("Intercept","Warming", "Mowing", "Warming:MowE")
TV.selection$Included = NA

AIC = rep(NA, length = length(unique(TV.selection$Method)))
for(i in TV.selection$Method){
  for(j in TV.selection$Variable){
    #browser()
    TV.selection$Included[TV.selection$Method == i & TV.selection$Variable == j] = ifelse( j %in% names(fitTV.select[[i]][["coefficients"]]), 1,0 )
  }
  AIC[which(unique(TV.selection$Method) == i)] = AIC(fitTV.select[[i]])
}

TV.selection$id <- rep(1:4,times = 6)
TV.selection = dcast(data = TV.selection,formula = Variable~Method,fun.aggregate = sum,value.var = "Included")
###FIX THIS###
#TV.selection = rbind(TV.selection, as.matrix(c("",round(AIC),4),nrow = 1))
#TV.selection[,-c(1)] = ifelse(TV.selection[,-c(1)] == 1, "Y", "")
TV.selection[,1] = c("Intercept","Mowing","Warming","Warming:Mowing")
colnames(TV.selection) = c("Variable", "AIC: Forward", "AIC: Backward", "AIC: Both", "BIC: Forward", "BIC: Backward", "BIC: Both")

kable(TV.selection)
```

Backward and bi-directional selection for AIC and BIC support the warmign and mowing model, though forward selection suggests an intercept only model in both cases of AIC and BIC. 

Thus, based on the results of the partial F-test and AIC/BIC model selection, we conclude that $Terminal Velocity = \beta_0 + \beta_1 Mowing+ \beta_2  Warming$ is the best model for our data. The results of this model are shown in __ and treatment level predictions are shown in Figure \ref{fig:TV_ANOVATrtEst}.

```{r TV_ANOVATrtEst, fig.cap="\\label{fig:TV_ANOVATrtEst}Results of best fitting ANOVA model, which included both warming and mowing as predictors. Square dots show mean predicted value and error bars show 95% confidence intervals."}
mowWarm.dat = expand.grid(Mow = c("CTL", "E", "L"), Warming = c("A", "W"))
mowWarm.dat = cbind(mowWarm.dat, predict(mod.mowWarm.log, newdata = mowWarm.dat, interval = "confidence"))
mowWarm.dat = do.call(data.frame, mowWarm.dat)

ggplot(data = mowWarm.dat, aes(x = Mow, color = Warming))+
  geom_point(aes(y = fit), position = position_dodge(0.5), size = 2, shape = 15)+
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2, position = position_dodge(0.5))+
  labs(y = "Estimated log(Terminal Velocity)")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```



# Research Question 3



# Discussion

# References
1. US National Plant Germplasm System. Website  [npgsweb.ars-grin.gov](https://npgsweb.ars-grin.gov/gringlobal/taxonomydetail.aspx?id=104109) accessed 10 December 2019.
2. USDA Natural Resources Conservation Service. Website [plants.usda.gov](https://plants.usda.gov/core/profile?symbol=CANU4) accessed 10 December 2019.
3. Katul *et al.* 2005. *American Naturalist*, 166(3), pp. 368-381. 
4. Skarpaas and Shea 2007. *American Naturalist*, 170(3), pp. 421-430. 