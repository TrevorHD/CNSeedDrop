---
title: "Final Project Report"
author: "Trevor Drees and Emily Howerton"
date: "December 15, 2019"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: no
    fig_height: 4
    fig_width: 5
editor_options: 
  chunk_output_type: console
header-includes:
- \usepackage{float}
- \usepackage[width=0.8\textwidth]{caption}
---

```{r setup, include = FALSE}

# Load packages
library(knitr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
#library(agricolae)
library(MASS)
library(maditr)
library(corrplot)
library(leaps)
library(car)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.pos = 'H')



#Initialise data
data <- read.csv("SeedDropData.csv")

# Treating pappus as cone-shaped, calculate vertex angle, base area, volume, and height
# Also calculate terminal velocity given drop time and fixed drop height
data %>% mutate(SeedAngle = acos(1 - ((SeedWidth^2)/(2*(SeedLength^2)))),
                SeedArea = pi*((SeedWidth/2)^2),
                SeedHeight = sqrt(SeedLength^2 - (SeedWidth/2)^2),
                SeedVol = (pi/3)*((SeedWidth/2)^2)*SeedHeight,
                TV = 1.25/DT.Avg) -> data

# Create new data set that excludes instances where pappus length, width, or DT are NA
data.new <- data[complete.cases(data[ , 23:25]), ]

# Need unique plot indicators by block - plot 1 and plot 2 are not similar in any way across blocks
data.new$PlotUnique = as.factor(paste(data.new$Block,"_",data.new$Plot))
# use PlantID for position

# Create a mowing y/n flag
data.new$MowYN = ifelse(data.new$Mow == "CTL", 0, 1)
```

# Abstract

# Introduction and Data

As the world has become significantly more interconnected, the increased movement of people across the world has also facilitated an increase in the spread of species outside of their native ranges. When species that are introduced outside of their native range become invasive, they can have a detrimental impact on local biodiversity, quantity and quality of valuable ecosystem services, and other aspects of the local ecosystem. Because of this, the study of invasive species has been a large part of the ecology literature in recent decades, ranging from theoretical models of how they spread to investigating possible management practices that keep them at bay.

One particular invasive species that has greatly expanded its range due to human activity is *Carduus nutans*, also known as "musk thistle" or "nodding thistle". This thistle is native to Europe and Central Asia, but has expanded its range into North America, Australia, and New Zealand, among other parts of the world (source). Within the U.S., this thistle has been reported in all U.S. states except for Alaska, Florida, Hawaii, Maine, and Vermont (source); the thistle may even be present in these states, but has not yet been reported. It is also been reported all Canadian provinces except Nunavut, Northwest Territories, and Yukon Territories (source).
  
*C. nutans* is considered to be a noxious weed in many U.S. states for several reasons. Because it can occur in very large numbers and grow to be quite large, this thistle may form dense and often impenetrable stands. The plant is also covered in numerous large spines, making it painful when touched as well as unpalatable to grazing animals. The adverse impacts of this weed on grazing can also lead to substantial economic losses.

Another reason why there is concern over *C. nutans* is because it has a high potential to spread locally when introduced, as it is wind dispersed and large pappi on the seeds allow them to be transported great distances. Models have been proposed to model such wind-driven seed dispersal (source), and such models have been applied to *C. nutans* (source), showing significant potential for long-range dispersal events. While there are abiotic and biotic factors that affect how far a seed like those in *C. nutans* can be dispersed, a noteworthy predictor of dispersal distance is seed terminal velocity. For seeds, a higher terminal velocity generally means a decreased dispersal distance; this is because a higher terminal velocity means the seed falls faster and thus spends less time in the air, which means less of an opportunity for wind to carry it further from its source.

However, it is not entirely clear what affects terminal velocity in *C. nutans* seeds, though the most obvious candidates would be physical properties of the seed such as shape and mass. In general, seeds with a larger area perpendicular to the direction of motion will have higher drag and a lower terminal velocity. Seeds with a higher mass will have a higher downward force (mg) from gravity and thus a higher air resistance force that must equal it to achieve terminal velocity, which leads to a higher terminal velocity since said resistance force is proportional to that velocity. However, the physical properties of the seed may be affected by the morphology and physiology of the parent plant; abiotic and biotic factors can affect the parent plant in such a way that may ultimately influence the terminal velocity of its seeds.

Given that there may be a link between abiotic influences on *C. nutans* and the terminal velocity of its seeds, we wish to investigate whether certain treatments applied to the plant before it flowers have any effect on seed dispersal capabilities. Any treatment effects that can reduce the dispersal capability of these thistles may then be used to inform management decisions. By using mowing treatment as well as a warming treatment (and combinations of the two), we will examine the effects of said treatments on seed terminal velocity and thus on dispersal capability.

The data used to assess the effectiveness of the treatments were collected during a field experiment which crossed warming and mowing treatments.  There were ten blocks, where each block subset into two plots - one warmed treatment and one ambient. Within a plot there are three positions, one for each mowing treatment. Ten seeds were planted at each position. One flower head was harvested from all individuals that survived to harvest date. Seeds were collected from individual flower heads and subsequently tested in a drop chamber. Seed drop tests were repeated until two drop times were recorded within 0.1 seconds. With these data, we want to assess the variation in drop time of seeds from plants under warming and/or mowing.

With this data, we will address three main research questions:

\begin{enumerate}
\item Is seed terminal velocity predicted by seed shape parameters?
\item To what extent do warming and mowing treatments change seed terminal velocity?
\item Can changes in terminal velocity by treatment be explained by changes in seed shape parameters?
\end{enumerate}

# Research Question 1 

``` {r}
# Remove any rows where the quantities defined above are NaN
data.new <- data.new[-which(is.nan(data.new[, 36])), ]
```

Before any models were fit to the data, we first examined correlations between the various seed physical properties. The `pairs` plot for terminal velocity and the various physical properties is shown below:

``` {r}
pairs(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")])
```

Linear correlations between the variables can also be shown in a heatmap of the correlation matrix:

``` {r}
corrplot(cor(data.new[, c("TV", "SeedLength", "SeedWidth", "SeedAngle", "SeedArea", "SeedHeight", "SeedVol")]),
         method = "square", type = "upper")
```

Between both of these plots, it is clear that multicollinearity will be an issue since several of the variables are highly correlated with each other (e.g. `SeedWidth` and `SeedAngle`, `SeedWidth` and `SeedArea`, etc.). 

Our first model used the terminal veocity `TV` as a response and each of the physical properties as predictors. The resulting coefficients and their significance are listed below:

``` {r}
mod.full <- lm(TV ~ SeedWidth + SeedLength + SeedArea + SeedAngle + SeedHeight + 
                    SeedVol, data = data.new)
mod.full.out <- cbind(round(summary(mod.full)$coefficients, digits = 4),
                      c("", round(vif(mod.full), digits = 4)),
                      c("***", "**", ".", "", "", "", "*"))
dimnames(mod.full.out)[[2]] <- c("Estimate", "Std. Error", "t value", "Pr(>|t|)",
                                 "VIF", "Significance")
kable(mod.full.out)
```

It is clear that this model is a poor fit for two main reasons. First, many of the terms are not significant to $\alpha = 0.05$ and add no significant additional predictive power to the model. Second, the VIF for all of the coefficients is quite high, as was predicted.

Given that some of these variables must be removed to improve the fit of the model, we then performed variable selection on the full model to reduce clutter. The first method of selection was backwards selection from the full model; this involved removing subsequent variables based on their *p*-value; the variable with the highest *p*-value was removed, the resulting model examined, and the process repeated until all predictors were significant. The second method of selection involved backwards selection from the full model using AIC, where terms were removed until the AIC of the model was minimised. The third mehtod of selection started from the full model and used `step` selection in both directions, while the fourth method started from the null model and added terms; again, in both cases, the selection continued until the AIC of the model was minimised.

# Research Question 2

```{r TVbarplot,fig.cap="\\label{fig:TVbarplot}Terminal velocity for plants grown under warming and mowing treatments. Height of bar shows group mean, and error bars show one standard error. Actual data shown with black dots."}
barplot.dat = aggregate(data.new$TV, by = list(Mowing = data.new$Mow, Warming = data.new$Warming), FUN = function(x) c(mean(x),sd = sd(x), n = length(x)))
barplot.dat = do.call(data.frame, barplot.dat)
barplot.dat$SE = barplot.dat$x.sd / sqrt(barplot.dat$x.n)
colnames(barplot.dat) = c("Mowing", "Warming", "Mean", "SD", "n", "SE")

ggplot(data = barplot.dat, aes(Mowing, Mean, fill = Warming))+
  geom_bar(stat = "identity", position = position_dodge(0.9))+
  geom_point(data = data.new, aes(x = Mow, group = Warming, y = TV), position = position_jitterdodge(dodge.width = 0.9), alpha = 0.5, shape = 16)+
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2, position = position_dodge(0.9))+
  labs(y = "Terminal Velocity")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r TVHistAndErrors,fig.cap="\\label{fig:TVHistAndErrors} Justification for transofmraiton of terminal velocity. Histogram of terminal velocity (A) and Normal-QQ plot of linear model, with both warming and mowing predictors."}

# show TV histogram
p1 = ggplot(data = data.new)+
  geom_histogram(aes(TV), fill = "white", color = "black", bins = 10)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x = "Terminal Velocity", y = "Count", tag = "A")
# show residuals 
mod.TV = lm(TV ~ Warming + Mow, data = data.new)
resid = as.data.frame(mod.TV$residuals)
colnames(resid) = c("Residuals")
p2 = ggplot(resid, aes(sample = Residuals))+
  stat_qq() + 
  stat_qq_line()+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x = "Theoretical", y = "Sample", tag = "B")
grid.arrange(p1, p2, nrow = 1)

```

```{r TV_ModelSelection, include = FALSE}
fit.TV = lm(log(TV) ~ Warming * Mow, data = data.new)
fitTV.select = list()
#AIC
fitTV.select$AICBoth = stepAIC(fit.TV, direction = "both")
fitTV.select$AICBackward = stepAIC(fit.TV, direction =  "backward")
fitTV.select$AICForward = stepAIC(lm(log(TV)~1, data = data.new), direction =  "forward")
#BIC
fitTV.select$BICBoth = stepAIC(fit.TV, direction = "both", k = log(length(data.new)))
fitTV.select$BICBackward = stepAIC(fit.TV, direction =  "backward", k = log(length(data.new)))
fitTV.select$BICForward = stepAIC(lm(log(TV)~1, data = data.new), direction =  "forward", k = log(length(data.new)))
```

```{r TV_ModelSelectionTable, fig.cap="\\label{fig:TV_ModelSelectionTable}CAPTION"}
# results of model selection
TV.selection = expand.grid(Variable = c("(Intercept)","MowE","WarmingW", "WarmingW:MowE"), Method = c("AICForward", "AICBackward", "AICBoth", "BICForward", "BICBackward", "BICBoth"))
#TV.selection$Method = c("AIC: Forward", "AIC: Backward", "AIC: Bi-directional", "BIC: Forward", "BIC: Backward", "BIC: Bi-directional")
#TV.selection$Variable = c("Intercept","Warming", "Mowing", "Warming:MowE")
TV.selection$Included = NA

for(i in TV.selection$Method){
  for(j in TV.selection$Variable){
   TV.selection$Included[TV.selection$Method == i & TV.selection$Variable == j] = ifelse( j %in% names(fitTV.select[[i]][["coefficients"]]), 1,0 )
  }
}
TV.selection$id <- rep(1:4,times = 6)
TV.selection = dcast(data = TV.selection,formula = Variable~Method,fun.aggregate = sum,value.var = "Included")
#TV.selection[,2:7] = ifelse(TV.selection[,2:7] == 1, "Y", "")
TV.selection[,1] = c("Intercept","Mowing","Warming","Warming:Mowing")
colnames(TV.selection) = c("Variable", "AIC: Forward", "AIC: Backward", "AIC: Both", "BIC: Forward", "BIC: Backward", "BIC: Both")
kable(TV.selection)
```

```{r ByTreatment_ANOVA_log, include = FALSE}
# warming
mod.warm.log = lm(log(TV) ~ Warming, data= data.new)
summary(mod.warm.log)

# early vs. late mowing 
mod.mow.log = lm(log(TV) ~ Mow, data= data.new)
summary(mod.mow.log)
TukeyHSD(aov(log(TV) ~ Mow, data= data.new))

# no interaction (E/L mow)
mod.mowWarm.log = lm(log(TV) ~ Mow + Warming, data = data.new)
summary(mod.mowWarm.log)

mod.int.log = lm(log(TV) ~ Mow + Warming + Mow:Warming, data= data.new)
summary(mod.int.log)
anova(mod.int.log)

# partial F test: compare full model to warming only model
anova(mod.warm.log, mod.mowWarm.log, mod.int.log)
```

```{r TV_ANOVATrtEst, fig.cap="\\label{fig:TV_ANOVATrtEst}Results of best fitting ANOVA model, which included both warming and mowing as predictors. Square dots show mean predicted value and error bars show 95% confidence intervals."}
mowWarm.dat = expand.grid(Mow = c("CTL", "E", "L"), Warming = c("A", "W"))
mowWarm.dat = cbind(mowWarm.dat, predict(mod.mowWarm.log, newdata = mowWarm.dat, interval = "confidence"))
mowWarm.dat = do.call(data.frame, mowWarm.dat)

ggplot(data = mowWarm.dat, aes(x = Mow, color = Warming))+
  geom_point(aes(y = fit), position = position_dodge(0.5), size = 2, shape = 15)+
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2, position = position_dodge(0.5))+
  labs(y = "Estimated log(Terminal Velocity)")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

The following analysis will quantify the extent to which seed terminal velocity changed under warming and mowing treatments. Figure \ref{fig:TVbarplot} shows the mean of each treatment. There are fewer points for late mowed plants, as many of them died due to the mowing treatment. To assess whether warming and mowing treatment significantly changed terminal velocity we used ANOVA models. We log-transformed terminal velocity to compensate for skewed right distribution of the terminal velocity data and sinificant deviations from error normality (Figure \ref{fig:TVHistAndErrors}). 

Using log-transformed terminal velocity, we use two methods to identify what is the most appropriate model to describe changes in terminal velocity based on the treatments.

# Research Question 3



# Discussion
